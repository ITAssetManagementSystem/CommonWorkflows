name: Reusable CD - Microservice Deploy (Helm + AKS)

on:
  workflow_call:
    inputs:
      service_name:
        type: string
        required: true

      namespace:
        type: string
        required: true

      values_file:
        type: string
        required: true

      chart_name:
        type: string
        default: service

      chart_version:
        type: string
        required: true

      acr_name:
        type: string
        required: true

      aks_name:
        type: string
        required: true

      resource_group:
        type: string
        required: true

      dockerfile_path:
        type: string
        default: Dockerfile

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read # â›” no write to service repo

    env:
      IMAGE_TAG: ${{ github.sha }}

    steps:
      # =========================
      # Checkout Service Repo
      # =========================
      - uses: actions/checkout@v4

      # =========================
      # Azure Login (OIDC)
      # =========================
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      # =========================
      # Login to ACR
      # =========================
      - name: Login to ACR
        run: |
          az acr login --name ${{ inputs.acr_name }}

      # =========================
      # Build & Push Docker Image
      # =========================
      - name: Build & Push Docker Image
        run: |
          docker build \
            -t ${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }}:${{ env.IMAGE_TAG }} \
            -f ${{ inputs.dockerfile_path }} .

          docker push \
            ${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }}:${{ env.IMAGE_TAG }}

      # =========================
      # AKS + Helm (INTENTIONALLY KEPT, NOT USED)
      # =========================
      # - name: Get AKS Credentials
      #   run: |
      #     az aks get-credentials \
      #       --name ${{ inputs.aks_name }} \
      #       --resource-group ${{ inputs.resource_group }} \
      #       --overwrite-existing

      # - name: Helm Dry Run (Server)
      #   run: |
      #     helm template ${{ inputs.service_name }} \
      #       oci://${{ inputs.acr_name }}.azurecr.io/helm/${{ inputs.chart_name }} \
      #       --version ${{ inputs.chart_version }} \
      #       --namespace ${{ inputs.namespace }} \
      #       -f ${{ inputs.values_file }} \
      #       --set image.repository=${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }} \
      #       --set image.tag=${{ env.IMAGE_TAG }} \
      #     | kubectl apply --dry-run=server -f -

      # =========================
      # Generate GitHub App Token
      # =========================
      - name: Generate GitHub App Token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      # =========================
      # Clone GitOps Repo
      # =========================
      - name: Clone GitOps Repo
        run: |
          git clone https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ secrets.GITOPS_REPO }}.git gitops
          cd gitops

      # =========================
      # Update values.yaml in GitOps Repo
      # =========================
      - name: Update image tag
        run: |
          cd gitops
          yq e '.image.tag = env(IMAGE_TAG)' -i services/${{ inputs.service_name }}/values.yaml

      # =========================
      # Create PR to GitOps Repo
      # =========================
      - name: Create GitOps PR
        run: |
          cd gitops
          git checkout -b deploy/${{ inputs.service_name }}-${IMAGE_TAG}
          git add services/${{ inputs.service_name }}/values.yaml
          git commit -m "deploy(${{
            inputs.service_name }}): ${IMAGE_TAG}"
          git push origin deploy/${{ inputs.service_name }}-${IMAGE_TAG}

          gh pr create \
            --repo ${{ secrets.GITOPS_REPO }} \
            --title "Deploy ${{ inputs.service_name }} ${IMAGE_TAG}" \
            --body "Automated image update via CI"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
