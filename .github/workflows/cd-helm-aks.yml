name: Reusable CD - Helm AKS (OCI)

on:
  workflow_call:
    inputs:
      service_name:
        type: string
        required: true

      chart_path:
        type: string
        required: true

      values_file:
        type: string
        required: true

      namespace:
        type: string
        required: true

      acr_name:
        type: string
        required: true

      aks_name:
        type: string
        required: true

      resource_group:
        type: string
        required: true

      dockerfile_path:
        type: string
        default: Dockerfile

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    env:
      IMAGE_TAG: ${{ github.sha }}
      HELM_CHART_VERSION: 0.1.${{ github.run_number }}

    steps:
      # =========================
      # Checkout
      # =========================
      - uses: actions/checkout@v4

      # =========================
      # Azure Login (OIDC)
      # =========================
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      # =========================
      # ACR Login
      # =========================
      - name: Login to ACR
        run: |
          az acr login --name ${{ inputs.acr_name }}

      # =========================
      # Docker Build & Push
      # =========================
      - name: Build & Push Docker Image
        run: |
          docker build \
            -t ${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }}:${{ env.IMAGE_TAG }} \
            -f ${{ inputs.dockerfile_path }} .

          docker push ${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }}:${{ env.IMAGE_TAG }}

      # =========================
      # Helm Lint
      # =========================
      - name: Helm Lint
        run: |
          helm lint ${{ inputs.chart_path }} -f ${{ inputs.values_file }}

      # =========================
      # Helm Package
      # =========================
      - name: Helm Package
        run: |
          helm package ${{ inputs.chart_path }} \
            --version ${{ env.HELM_CHART_VERSION }} \
            --app-version ${{ env.IMAGE_TAG }}

      # =========================
      # Push Helm Chart to ACR (OCI)
      # =========================
      - name: Push Helm Chart to ACR
        run: |
          helm push \
            ${{ inputs.service_name }}-${{ env.HELM_CHART_VERSION }}.tgz \
            oci://${{ inputs.acr_name }}.azurecr.io/helm

      # =========================
      # Get AKS Credentials
      # =========================
      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --name ${{ inputs.aks_name }} \
            --resource-group ${{ inputs.resource_group }} \
            --overwrite-existing

      # =========================
      # Pre-Deploy Validation (OCI)
      # =========================
      - name: Kubernetes API Dry Run
        run: |
          helm template ${{ inputs.service_name }} \
            oci://${{ inputs.acr_name }}.azurecr.io/helm/${{ inputs.service_name }} \
            --version ${{ env.HELM_CHART_VERSION }} \
            --namespace ${{ inputs.namespace }} \
            -f ${{ inputs.values_file }} \
            --set image.repository=${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
          | kubectl apply --dry-run=server -f -

      # =========================
      # Helm Upgrade (Atomic)
      # =========================
      - name: Deploy to AKS
        run: |
          helm upgrade --install ${{ inputs.service_name }} \
            oci://${{ inputs.acr_name }}.azurecr.io/helm/${{ inputs.service_name }} \
            --version ${{ env.HELM_CHART_VERSION }} \
            --namespace ${{ inputs.namespace }} \
            --create-namespace \
            -f ${{ inputs.values_file }} \
            --set image.repository=${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --atomic \
            --wait \
            --timeout 10m
