name: Reusable CD - Microservice Deploy (Helm + AKS)

on:
  workflow_call:
    inputs:
      service_name:
        type: string
        required: true

      namespace:
        type: string
        required: true

      values_file:
        type: string
        required: true

      chart_name:
        type: string
        default: service

      chart_version:
        type: string
        required: true

      acr_name:
        type: string
        required: true

      aks_name:
        type: string
        required: true

      resource_group:
        type: string
        required: true

      dockerfile_path:
        type: string
        default: Dockerfile

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: write

    env:
      IMAGE_TAG: ${{ github.sha }}

    steps:
      # =========================
      # Checkout Code
      # =========================
      - uses: actions/checkout@v4

      # =========================
      # Azure Login (OIDC)
      # =========================
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      # =========================
      # Login to ACR
      # =========================
      - name: Login to ACR
        run: |
          az acr login --name ${{ inputs.acr_name }}

      # =========================
      # Build & Push Docker Image
      # =========================
      - name: Build & Push Docker Image
        run: |
          docker build \
            -t ${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }}:${{ env.IMAGE_TAG }} \
            -f ${{ inputs.dockerfile_path }} .

          docker push \
            ${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }}:${{ env.IMAGE_TAG }}

      # =========================
      # Get AKS Credentials
      # =========================
      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --name ${{ inputs.aks_name }} \
            --resource-group ${{ inputs.resource_group }} \
            --overwrite-existing

      # =========================
      # Pre-deploy Validation
      # =========================
      - name: Helm Dry Run (Server)
        run: |
          helm template ${{ inputs.service_name }} \
            oci://${{ inputs.acr_name }}.azurecr.io/helm/${{ inputs.chart_name }} \
            --version ${{ inputs.chart_version }} \
            --namespace ${{ inputs.namespace }} \
            -f ${{ inputs.values_file }} \
            --set image.repository=${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
          | kubectl apply --dry-run=server -f -

      # =========================
      # Deploy to AKS
      # =========================
      # - name: Deploy to AKS (Helm Upgrade)
      #   run: |
      #     helm upgrade --install ${{ inputs.service_name }} \
      #       oci://${{ inputs.acr_name }}.azurecr.io/helm/${{ inputs.chart_name }} \
      #       --version ${{ inputs.chart_version }} \
      #       --namespace ${{ inputs.namespace }} \
      #       --create-namespace \
      #       -f ${{ inputs.values_file }} \
      #       --set image.repository=${{ inputs.acr_name }}.azurecr.io/${{ inputs.service_name }} \
      #       --set image.tag=${{ env.IMAGE_TAG }} \
      #       --atomic \
      #       --wait \
      #       --timeout 10m

      # =========================
      # Update Helm values.yaml
      # =========================
      - name: Update image tag in values.yaml
        run: |
          yq e '.image.tag = env(IMAGE_TAG)' -i helm/values.yaml

      # =========================
      # Commit & Push Changes
      # =========================
      - name: Commit and Push values.yaml
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add helm/values.yaml
          git commit -m "deploy(asset-service): ${IMAGE_TAG}"
          git push
